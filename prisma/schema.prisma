// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
  directUrl = env("POSTGRES_URL")
  relationMode = "prisma"
}

// Auth.js models
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?   // For credentials provider
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  memberships   Membership[]
  userAnalytics UserAnalytics[]
  userProfiles  UserProfile[]
  reminders     Reminder[]
  reminderPreferences ReminderPreference[]
  insights      Insight[]
  patterns      Pattern[]
  approvedActions AgentAction[] @relation("ApprovedActions")
  plans         Plan[]
  agentActivities AgentActivity[]
  agentSettings AgentSettings[]
  messageLogs MessageLog[]
  predictions Prediction[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Multi-tenant models
model Tenant {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]
  invites     Invite[]
  people       Person[]
  projects     Project[]
  ideas        Idea[]
  adminItems   Admin[]
  inboxLogs    InboxLog[]
  digests      Digest[]
  customDigestTemplates CustomDigestTemplate[]
  ruleSettings RuleSettings?
  ruleCategories RuleCategory[]
  rulePrompts  RulePrompt[]
  ruleRoutings RuleRouting[]
  attachments  Attachment[]
  comments     Comment[]
  actionHistory ActionHistory[]
  classificationAudits ClassificationAudit[]
  classificationCorrections ClassificationCorrection[]
  tags         Tag[]
  itemTags     ItemTag[]
  savedSearches SavedSearch[]
  tokenUsage   TokenUsage[]
  calendarEvents CalendarEvent[]
  embeddings   Embedding[]
  queryHistory QueryHistory[]
  relationships Relationship[]
  userAnalytics UserAnalytics[]
  userProfiles UserProfile[]
  reminders Reminder[]
  reminderPreferences ReminderPreference[]
  insights Insight[]
  patterns Pattern[]
  goals Goal[]
  goalProjects GoalProject[]
  goalIdeas GoalIdea[]
  goalProgresses GoalProgress[]
  agentActions AgentAction[]
  actionTemplates ActionTemplate[]
  workflows Workflow[]
  workflowExecutions WorkflowExecution[]
  plans Plan[]
  planSteps PlanStep[]
  integrations Integration[]
  webhookEvents WebhookEvent[]
  emails Email[]
  calendarSyncs CalendarSync[]
  slackMessages SlackMessage[]
  notionSyncs NotionSync[]
  agentActivities AgentActivity[]
  agentSettings AgentSettings[]
  messageLogs MessageLog[]
  predictions Prediction[]
  audioNotes AudioNote[]
  taskTemplates TaskTemplate[]
  taskDependencies TaskDependency[]
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  role      String   @default("member") // owner, admin, member
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
}

model Invite {
  id        String   @id @default(cuid())
  tenantId  String
  email     String
  role      String   @default("member")
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([token])
  @@index([email])
}

// Domain models
model Person {
  id          Int      @id @default(autoincrement())
  tenantId    String
  name        String
  context     String?
  followUps   String?  @map("follow_ups")
  lastTouched String?  @map("last_touched")
  tags        String?
  archived    Int      @default(0)
  archivedAt  DateTime? @map("archived_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([name])
  @@index([archived])
  @@map("people")
}

model Project {
  id          Int      @id @default(autoincrement())
  tenantId    String
  name        String
  status      String   @default("Active")
  nextAction  String?  @map("next_action")
  notes       String?
  archived    Int      @default(0)
  archivedAt  DateTime? @map("archived_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tasks  Admin[]

  @@index([tenantId])
  @@index([status])
  @@index([archived])
  
  goalProjects GoalProject[]
  @@map("projects")
}

model Idea {
  id          Int      @id @default(autoincrement())
  tenantId    String
  name        String
  oneLiner    String?  @map("one_liner")
  notes       String?
  lastTouched String?  @map("last_touched")
  tags        String?
  archived    Int      @default(0)
  archivedAt  DateTime? @map("archived_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  goalIdeas GoalIdea[]

  @@index([tenantId])
  @@index([archived])
  @@map("ideas")
}

model Admin {
  id                Int      @id @default(autoincrement())
  tenantId          String
  name              String
  dueDate           String?  @map("due_date")
  startDate         DateTime? @map("start_date")
  status            String   @default("Todo")
  priority          String?  @default("medium") // low, medium, high, urgent
  notes             String?  @db.Text
  completedAt       DateTime? @map("completed_at")
  estimatedDuration Int?     @map("estimated_duration") // minutes
  actualDuration    Int?     @map("actual_duration") // minutes
  recurrenceRule    String?  @map("recurrence_rule") @db.Text // JSON for recurring tasks
  parentTaskId      Int?     @map("parent_task_id") // for sub-tasks
  projectId         Int?     @map("project_id") // explicit link to projects
  assigneeId        String?  @map("assignee_id") // userId for future multi-user
  archived          Int      @default(0)
  archivedAt       DateTime? @map("archived_at")
  created           DateTime @default(now())
  updatedAt         DateTime @updatedAt @map("updated_at")

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentTask        Admin?   @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  subTasks          Admin[]  @relation("TaskSubtasks")
  project           Project? @relation(fields: [projectId], references: [id])
  blockingDeps      TaskDependency[] @relation("BlockingTasks")
  blockedByDeps     TaskDependency[] @relation("BlockedTasks")

  @@index([tenantId])
  @@index([archived])
  @@index([status])
  @@index([priority])
  @@index([projectId])
  @@index([parentTaskId])
  @@index([dueDate])
  @@index([startDate])
  @@index([completedAt])
  @@map("admin")
}

model InboxLog {
  id              Int      @id @default(autoincrement())
  tenantId        String
  originalText    String   @map("original_text")
  filedTo         String   @map("filed_to")
  destinationName String?  @map("destination_name")
  destinationUrl  String?  @map("destination_url")
  confidence      Float?
  status          String   @default("Filed")
  created         DateTime @default(now())
  notionRecordId  String?  @map("notion_record_id")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([created])
  @@index([status])
  @@index([filedTo])
  @@map("inbox_log")
}

model Digest {
  id        Int      @id @default(autoincrement())
  tenantId  String
  type      String
  content   String   @db.Text
  created   DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([type])
  @@index([created])
  @@map("digests")
}

model CustomDigestTemplate {
  id        Int      @id @default(autoincrement())
  tenantId  String
  name      String
  prompt    String   @db.Text
  created   DateTime @default(now())
  updated   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("custom_digest_templates")
}

model RuleSettings {
  id                    Int      @id @default(autoincrement())
  tenantId              String   @unique
  confidenceThreshold   Float    @default(0.7) @map("confidence_threshold")
  defaultProjectStatus  String   @default("Active") @map("default_project_status")
  defaultAdminStatus     String   @default("Todo") @map("default_admin_status")
  learningEnabled       Int      @default(1) @map("learning_enabled")
  maxLearningExamples   Int      @default(5) @map("max_learning_examples")
  exampleTimeframeDays  Int      @default(30) @map("example_timeframe_days")
  updatedAt             DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("rule_settings")
}

model RuleCategory {
  id          Int      @id @default(autoincrement())
  tenantId    String
  categoryKey String   @map("category_key")
  label       String
  description String?
  enabled     Int      @default(1)
  fieldSchema String?  @map("field_schema") @db.Text
  displayOrder Int     @default(0) @map("display_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, categoryKey])
  @@index([tenantId])
  @@index([categoryKey])
  @@index([enabled])
  @@map("rule_categories")
}

model RulePrompt {
  id        Int      @id @default(autoincrement())
  tenantId  String
  name      String
  template  String   @db.Text
  active    Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([active])
  @@map("rule_prompts")
}

model RuleRouting {
  id              Int      @id @default(autoincrement())
  tenantId        String
  categoryKey     String   @map("category_key")
  destinationTable String  @map("destination_table")
  fieldMapping    String?  @map("field_mapping") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, categoryKey])
  @@index([tenantId])
  @@index([categoryKey])
  @@map("rule_routing")
}

model Attachment {
  id         Int      @id @default(autoincrement())
  tenantId   String
  itemType   String   @map("item_type")
  itemId     Int      @map("item_id")
  filename   String
  filepath   String
  mimeType   String?  @map("mime_type")
  size       Int?
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, itemType, itemId])
  @@map("attachments")
}

model Comment {
  id        Int      @id @default(autoincrement())
  tenantId  String
  itemType  String   @map("item_type")
  itemId    Int      @map("item_id")
  fieldKey  String?  @map("field_key")
  content   String   @db.Text
  author    String   @default("User")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, itemType, itemId])
  @@index([fieldKey])
  @@map("comments")
}

model ActionHistory {
  id        Int      @id @default(autoincrement())
  tenantId  String
  actionType String  @map("action_type")
  itemType  String   @map("item_type")
  itemId    Int?     @map("item_id")
  oldData   String?  @map("old_data") @db.Text
  newData   String?  @map("new_data") @db.Text
  timestamp DateTime @default(now())
  undone    Int      @default(0)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, itemType, itemId])
  @@index([timestamp])
  @@index([undone])
  @@map("action_history")
}

model ClassificationAudit {
  id           Int      @id @default(autoincrement())
  tenantId     String
  messageText  String   @map("message_text")
  provider     String
  model        String?
  prompt       String?  @db.Text
  responseText String?  @map("response_text") @db.Text
  parsedResult String?  @map("parsed_result") @db.Text
  status       String
  errorMessage String?  @map("error_message") @db.Text
  created      DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([created])
  @@index([status])
  @@map("classification_audit")
}

model ClassificationCorrection {
  id                Int      @id @default(autoincrement())
  tenantId          String
  inboxLogId        Int      @map("inbox_log_id")
  originalCategory  String   @map("original_category")
  correctedCategory String   @map("corrected_category")
  messageText       String   @map("message_text") @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@index([tenantId, correctedCategory])
  @@index([createdAt])
  @@map("classification_corrections")
}

model Tag {
  id        Int      @id @default(autoincrement())
  tenantId  String
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  itemTags ItemTag[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([name])
  @@map("tags")
}

model ItemTag {
  tenantId  String
  itemType  String   @map("item_type")
  itemId    Int      @map("item_id")
  tagId     Int      @map("tag_id")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([tenantId, itemType, itemId, tagId])
  @@unique([tenantId, itemType, itemId, tagId])
  @@index([tenantId, itemType, itemId])
  @@index([tagId])
  @@map("item_tags")
}

model SavedSearch {
  id        Int      @id @default(autoincrement())
  tenantId  String
  name      String
  query     String?
  filters   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([updatedAt])
  @@map("saved_searches")
}

model TokenUsage {
  id              Int      @id @default(autoincrement())
  tenantId        String
  provider        String   // 'openai' | 'anthropic'
  model           String
  operationType   String   @map("operation_type") // 'classification' | 'digest'
  promptTokens    Int      @map("prompt_tokens")
  completionTokens Int     @map("completion_tokens")
  totalTokens     Int      @map("total_tokens")
  created         DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([created])
  @@index([provider])
  @@index([operationType])
  @@map("token_usage")
}

model CalendarEvent {
  id          Int      @id @default(autoincrement())
  tenantId    String
  subject     String
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  location    String?
  attendees   String?
  description String?  @db.Text
  isAllDay    Boolean  @default(false) @map("is_all_day")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([startTime])
  @@index([endTime])
  @@index([tenantId, startTime, endTime])
  @@map("calendar_events")
}

model Embedding {
  id        Int      @id @default(autoincrement())
  tenantId  String
  itemType  String   @map("item_type")
  itemId    Int      @map("item_id")
  text      String   @db.Text
  embedding String   @db.Text // JSON array of floats
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, itemType, itemId])
  @@index([tenantId, itemType, itemId])
  @@map("embeddings")
}

model QueryHistory {
  id          Int      @id @default(autoincrement())
  tenantId    String
  query       String   @db.Text
  resultCount Int      @default(0) @map("result_count")
  createdAt   DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, createdAt])
  @@map("query_history")
}

model Relationship {
  id              Int      @id @default(autoincrement())
  tenantId        String
  sourceType      String   @map("source_type")
  sourceId        Int      @map("source_id")
  targetType      String   @map("target_type")
  targetId        Int      @map("target_id")
  relationshipType String  @default("mentioned_in") @map("relationship_type")
  strength        Float    @default(0.5)
  mentionCount    Int      @default(1) @map("mention_count")
  lastMentioned   DateTime @default(now()) @map("last_mentioned")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, sourceType, sourceId, targetType, targetId])
  @@index([tenantId, sourceType, sourceId])
  @@index([tenantId, targetType, targetId])
  @@index([tenantId, relationshipType])
  @@index([strength])
  @@map("relationships")
}

model UserAnalytics {
  id                  Int      @id @default(autoincrement())
  tenantId            String
  userId              String
  captureCount        Int      @default(0) @map("capture_count")
  avgConfidence       Float?   @map("avg_confidence")
  mostCommonCategory  String?  @map("most_common_category")
  preferredCaptureTime String? @map("preferred_capture_time") // hour of day
  preferredCaptureDay  String? @map("preferred_capture_day")  // day of week
  correctionCount     Int      @default(0) @map("correction_count")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId, userId])
  @@map("user_analytics")
}

model UserProfile {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  preferences     String   @db.Text // JSON preferences
  frequentPeople  String?  @db.Text @map("frequent_people") // JSON array
  activeFocusAreas String? @db.Text @map("active_focus_areas") // JSON array
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId, userId])
  @@map("user_profiles")
}

model Reminder {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  reminderType    String   @map("reminder_type") // due_date, follow_up, stale_item, etc.
  itemType        String   @map("item_type") // people, projects, ideas, admin
  itemId          Int      @map("item_id")
  title           String
  message         String   @db.Text
  dueDate         DateTime? @map("due_date")
  priority        String   @default("medium") // low, medium, high
  status          String   @default("active") // active, snoozed, dismissed, completed
  snoozedUntil    DateTime? @map("snoozed_until")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, status])
  @@index([tenantId, dueDate])
  @@index([tenantId, reminderType])
  @@index([tenantId, itemType, itemId])
  @@map("reminders")
}

model ReminderPreference {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  reminderType    String   @map("reminder_type")
  enabled         Boolean  @default(true)
  quietHoursStart String?  @map("quiet_hours_start") // HH:MM
  quietHoursEnd   String?  @map("quiet_hours_end") // HH:MM
  frequency       String   @default("daily") // immediate, hourly, daily, weekly
  channels        String   @db.Text // JSON array: ["in_app", "push", "email"]
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, reminderType])
  @@index([tenantId, userId])
  @@map("reminder_preferences")
}

model Insight {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  insightType     String   @map("insight_type") // pattern, stagnation, opportunity, trend
  title           String
  message         String   @db.Text
  data            String?  @db.Text // JSON data for insights
  actionable      Boolean  @default(true)
  actionType      String?  @map("action_type") // convert_to_project, archive, update, etc.
  actionTargetId  Int?     @map("action_target_id")
  priority        String   @default("medium")
  status          String   @default("active") // active, dismissed, acted_upon
  createdAt       DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, status])
  @@index([tenantId, insightType])
  @@index([tenantId, createdAt])
  @@map("insights")
}

model Pattern {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  patternType     String   @map("pattern_type") // capture_frequency, category_distribution, etc.
  patternData     String   @db.Text @map("pattern_data") // JSON pattern data
  detectedAt      DateTime @default(now()) @map("detected_at")
  confidence      Float    @default(0.5)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId, patternType])
  @@index([tenantId, detectedAt])
  @@map("patterns")
}

model Goal {
  id              Int      @id @default(autoincrement())
  tenantId        String
  name            String
  description     String?  @db.Text
  targetDate      DateTime? @map("target_date")
  status          String   @default("active") // active, completed, paused, cancelled
  progress        Float    @default(0) // 0-100
  progressMethod  String   @default("manual") @map("progress_method") // manual, auto_from_items
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  linkedProjects  GoalProject[]
  linkedIdeas     GoalIdea[]
  progressHistory GoalProgress[]
  
  @@index([tenantId, status])
  @@index([tenantId, targetDate])
  @@map("goals")
}

model GoalProject {
  id              Int      @id @default(autoincrement())
  tenantId        String
  goalId          Int      @map("goal_id")
  projectId       Int      @map("project_id")
  weight          Float    @default(1.0) // Contribution weight
  createdAt       DateTime @default(now()) @map("created_at")
  
  goal            Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, goalId, projectId])
  @@index([tenantId, goalId])
  @@index([tenantId, projectId])
  @@map("goal_projects")
}

model GoalIdea {
  id              Int      @id @default(autoincrement())
  tenantId        String
  goalId          Int      @map("goal_id")
  ideaId          Int      @map("idea_id")
  weight          Float    @default(1.0)
  createdAt       DateTime @default(now()) @map("created_at")
  
  goal            Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  idea            Idea     @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, goalId, ideaId])
  @@index([tenantId, goalId])
  @@index([tenantId, ideaId])
  @@map("goal_ideas")
}

model GoalProgress {
  id              Int      @id @default(autoincrement())
  tenantId        String
  goalId          Int      @map("goal_id")
  progress        Float
  recordedAt      DateTime @default(now()) @map("recorded_at")
  
  goal            Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, goalId, recordedAt])
  @@map("goal_progress")
}

model AgentAction {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String?
  actionType      String   @map("action_type") // create, update, delete, link, notify, schedule
  targetType      String?  @map("target_type") // people, projects, ideas, admin
  targetId        Int?     @map("target_id")
  parameters      String   @db.Text // JSON parameters
  status          String   @default("pending") @map("status") // pending, approved, executing, executed, rejected, failed
  requiresApproval Boolean @default(true) @map("requires_approval")
  approvedBy      String?  @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  executedAt      DateTime? @map("executed_at")
  result          String?  @db.Text // JSON result
  errorMessage    String?  @db.Text @map("error_message")
  rollbackData    String?  @db.Text @map("rollback_data") // JSON state before action
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  approver        User?    @relation("ApprovedActions", fields: [approvedBy], references: [id])
  
  @@index([tenantId, status])
  @@index([tenantId, userId])
  @@index([tenantId, actionType])
  @@index([tenantId, createdAt])
  @@map("agent_actions")
}

model ActionTemplate {
  id              Int      @id @default(autoincrement())
  tenantId        String
  name            String
  description     String? @db.Text
  actions         String   @db.Text // JSON array of actions
  parameters      String?  @db.Text // JSON parameter schema
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId])
  @@map("action_templates")
}

model Workflow {
  id              Int      @id @default(autoincrement())
  tenantId        String
  name            String
  description     String?  @db.Text
  trigger         String   @db.Text // JSON trigger condition
  actions         String   @db.Text // JSON action sequence
  priority        Int      @default(0) @map("priority") // Higher = executes first
  enabled         Boolean  @default(true)
  executionCount  Int      @default(0) @map("execution_count")
  lastExecutedAt  DateTime? @map("last_executed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  executions      WorkflowExecution[]
  
  @@index([tenantId, enabled])
  @@index([tenantId, priority])
  @@map("workflows")
}

model WorkflowExecution {
  id              Int      @id @default(autoincrement())
  tenantId        String
  workflowId      Int      @map("workflow_id")
  status          String   // success, failed, skipped
  triggerData     String?  @db.Text @map("trigger_data") // JSON data that triggered
  executedActions String?  @db.Text @map("executed_actions") // JSON actions executed
  errorMessage    String?  @db.Text @map("error_message")
  executedAt      DateTime @default(now()) @map("executed_at")
  
  workflow        Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, workflowId])
  @@index([tenantId, executedAt])
  @@map("workflow_executions")
}

model Plan {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  name            String
  description     String?  @db.Text
  request         String   @db.Text // Original user request
  steps           String   @db.Text // JSON array of steps
  status          String   @default("draft") @map("status") // draft, approved, executing, completed, failed, cancelled
  approvedAt      DateTime? @map("approved_at")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  planSteps       PlanStep[]
  
  @@index([tenantId, userId, status])
  @@index([tenantId, createdAt])
  @@map("plans")
}

model PlanStep {
  id              Int      @id @default(autoincrement())
  tenantId        String
  planId          Int      @map("plan_id")
  stepOrder       Int      @map("step_order")
  actionType      String   @map("action_type")
  actionParams    String   @db.Text @map("action_params") // JSON parameters
  dependencies    String?  @db.Text // JSON array of step IDs
  status          String   @default("pending") @map("status") // pending, executing, completed, failed, skipped
  result          String?  @db.Text // JSON result
  errorMessage    String?  @db.Text @map("error_message")
  executedAt      DateTime? @map("executed_at")
  
  plan            Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, planId])
  @@index([tenantId, planId, stepOrder])
  @@map("plan_steps")
}

model Integration {
  id              Int      @id @default(autoincrement())
  tenantId        String
  provider        String   // gmail, slack, notion, google_calendar, etc.
  config          String   @db.Text // JSON config (encrypted tokens, settings)
  status          String   @default("disconnected") @map("status") // active, error, disconnected
  lastSync        DateTime? @map("last_sync")
  lastError       String?  @db.Text @map("last_error")
  errorCount      Int      @default(0) @map("error_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  webhookEvents   WebhookEvent[]
  emails Email[]
  calendarSyncs CalendarSync[]
  slackMessages SlackMessage[]
  notionSyncs NotionSync[]
  
  @@unique([tenantId, provider])
  @@index([tenantId, status])
  @@map("integrations")
}

model WebhookEvent {
  id              Int      @id @default(autoincrement())
  tenantId        String
  integrationId   Int      @map("integration_id")
  eventType       String   @map("event_type")
  payload         String   @db.Text // JSON payload
  status          String   @default("pending") @map("status") // pending, processed, failed
  processedAt     DateTime? @map("processed_at")
  errorMessage    String?  @db.Text @map("error_message")
  createdAt       DateTime @default(now()) @map("created_at")

  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, integrationId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("webhook_events")
}

model Email {
  id              Int      @id @default(autoincrement())
  tenantId        String
  integrationId   Int      @map("integration_id")
  messageId       String   @map("message_id") // Email message ID
  subject         String
  body            String   @db.Text
  senderEmail     String   @map("sender_email")
  senderName      String?  @map("sender_name")
  recipientEmail  String   @map("recipient_email")
  receivedAt      DateTime @map("received_at")
  classifiedAs    String?  @map("classified_as") // people, projects, ideas, admin
  linkedPersonId  Int?     @map("linked_person_id")
  linkedProjectId Int?     @map("linked_project_id")
  linkedAdminId   Int?     @map("linked_admin_id")
  attachments     String?  @db.Text // JSON array
  createdAt       DateTime @default(now()) @map("created_at")

  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, integrationId, messageId])
  @@index([tenantId, senderEmail])
  @@index([tenantId, receivedAt])
  @@index([tenantId, classifiedAs])
  @@map("emails")
}

model CalendarSync {
  id              Int      @id @default(autoincrement())
  tenantId        String
  integrationId   Int      @map("integration_id")
  itemType        String   @map("item_type") // admin, project, etc.
  itemId          Int      @map("item_id")
  calendarEventId String   @map("calendar_event_id") // External calendar event ID
  syncDirection   String   @map("sync_direction") // to_calendar, from_calendar, bidirectional
  lastSyncedAt    DateTime @default(now()) @map("last_synced_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, integrationId, itemType, itemId])
  @@index([tenantId, calendarEventId])
  @@map("calendar_sync")
}

model SlackMessage {
  id              Int      @id @default(autoincrement())
  tenantId        String
  integrationId   Int      @map("integration_id")
  messageId       String   @map("message_id") // Slack message ID
  channelId       String   @map("channel_id")
  channelName     String?  @map("channel_name")
  userId          String   @map("user_id") // Slack user ID
  userName        String?  @map("user_name")
  text            String   @db.Text
  threadTs        String?  @map("thread_ts") // Thread timestamp
  capturedAs      String?  @map("captured_as") // people, projects, ideas, admin
  linkedItemId    Int?     @map("linked_item_id")
  createdAt       DateTime @default(now()) @map("created_at")

  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, integrationId, messageId])
  @@index([tenantId, userId])
  @@index([tenantId, createdAt])
  @@map("slack_messages")
}

model NotionSync {
  id              Int      @id @default(autoincrement())
  tenantId        String
  integrationId   Int      @map("integration_id")
  itemType        String   @map("item_type")
  itemId          Int      @map("item_id")
  notionPageId    String   @map("notion_page_id")
  notionDatabaseId String? @map("notion_database_id")
  syncDirection   String   @map("sync_direction") // to_notion, from_notion, bidirectional
  lastSyncedAt    DateTime @default(now()) @map("last_synced_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, integrationId, itemType, itemId])
  @@index([tenantId, notionPageId])
  @@map("notion_sync")
}

model AgentActivity {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  activityType    String   @map("activity_type") // monitor, suggest, execute, learn
  actionType      String?  @map("action_type") // create, update, delete, etc.
  targetType      String?  @map("target_type")
  targetId        Int?     @map("target_id")
  description     String   @db.Text
  status          String   // pending, approved, executed, rejected
  userFeedback    String?  @map("user_feedback") // positive, negative, neutral
  confidence      Float?
  createdAt       DateTime @default(now()) @map("created_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, userId])
  @@index([tenantId, activityType])
  @@index([tenantId, createdAt])
  @@map("agent_activities")
}

model AgentSettings {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  proactivityLevel String  @default("medium") @map("proactivity_level") // low, medium, high
  approvalThreshold Float  @default(0.8) @map("approval_threshold") // 0-1 confidence threshold
  autoApproveTypes String? @db.Text @map("auto_approve_types") // JSON array of action types
  focusAreas      String?  @db.Text @map("focus_areas") // JSON array of areas to monitor
  notificationPreferences String? @db.Text @map("notification_preferences") // JSON preferences
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, userId])
  @@map("agent_settings")
}

model MessageLog {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  role            String   // user, assistant, system
  content         String   @db.Text
  category        String?  // What it was categorized as (people, projects, ideas, admin, Needs Review)
  destinationUrl  String?  @map("destination_url") @db.Text // Where it was filed
  timestamp       DateTime @default(now())

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, userId])
  @@index([tenantId, timestamp])
  @@index([tenantId, category])
  @@map("message_logs")
}

model Prediction {
  id              Int      @id @default(autoincrement())
  tenantId        String
  userId          String
  predictionType  String   @map("prediction_type") // capture, action, form_field
  predictedValue  String   @db.Text @map("predicted_value") // JSON predicted value
  confidence      Float
  context         String?  @db.Text // JSON context
  accepted        Boolean?
  createdAt       DateTime @default(now()) @map("created_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, userId])
  @@index([tenantId, predictionType])
  @@map("predictions")
}

model AudioNote {
  id              Int      @id @default(autoincrement())
  tenantId        String
  itemType        String   @map("item_type")
  itemId          Int      @map("item_id")
  filename        String
  filepath        String
  duration        Int?     // seconds
  transcription   String?  @db.Text
  transcriptionConfidence Float? @map("transcription_confidence")
  transcribedAt   DateTime? @map("transcribed_at")
  createdAt       DateTime @default(now()) @map("created_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, itemType, itemId])
  @@map("audio_notes")
}

model TaskDependency {
  id              Int      @id @default(autoincrement())
  tenantId        String
  taskId          Int      @map("task_id")
  dependsOnTaskId Int      @map("depends_on_task_id")
  dependencyType  String   @default("blocks") @map("dependency_type") // blocks, blocked_by
  createdAt       DateTime @default(now()) @map("created_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  task            Admin    @relation("BlockingTasks", fields: [taskId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  dependsOnTask   Admin    @relation("BlockedTasks", fields: [dependsOnTaskId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([tenantId, taskId, dependsOnTaskId])
  @@index([tenantId, taskId])
  @@index([tenantId, dependsOnTaskId])
  @@index([tenantId, dependencyType])
  @@map("task_dependencies")
}

model TaskTemplate {
  id              Int      @id @default(autoincrement())
  tenantId        String
  name            String
  description     String?   @db.Text
  fields          String    @db.Text // JSON with template fields
  defaultValues   String?   @db.Text @map("default_values") // JSON with default values
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("task_templates")
}
